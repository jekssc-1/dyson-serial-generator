<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Dyson Serial Generator</title>
<style>
  :root{--bg:#0f172a;--card:#111827ee;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--ring:#334155;--danger:#ef4444}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial;background:#0b1222;color:var(--text)}
  .wrap{max-width:1000px;margin:32px auto;padding:24px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:18px;box-shadow:0 10px 30px #0008;padding:24px}
  h1{margin:0 0 6px;font-size:28px}
  p.sub{margin:0 0 16px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{appearance:none;border:none;padding:12px 14px;border-radius:12px;font-weight:600;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
  .btn.primary{background:linear-gradient(135deg,var(--accent),#16a34a);color:#052e1c}
  .btn.secondary{background:#0b1222;border:1px solid var(--ring);color:#dbeafe}
  .btn.ghost{background:transparent;border:1px dashed var(--ring);color:#94a3b8}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed #1f2937}
  .out{white-space:pre-wrap;min-height:24px;font-family:ui-monospace,Menlo,Consolas,monospace;background:#020617;border:1px solid #1f2937;border-radius:14px;padding:14px}
  

.badge {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px 10px;
  height: 38px;
  border: 1px solid #1f2937;
  border-radius: 999px;
  background: #030712;
  color: #cbd5e1;
  font-size: 13px;
  transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
}
.badge.active {
  background: #2563eb; /* blue background */
  color: #fff;         /* white text */
  box-shadow: 0 0 8px rgba(59,130,246,0.7);
}


  dialog{width:600px;max-width:95vw;border:none;border-radius:16px;padding:0;background:#0b1222;color:var(--text);box-shadow:0 24px 80px #000b}
  dialog header{padding:16px 18px;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#111827,#0b1222)}
  dialog header h2{margin:0;font-size:18px}
  dialog .body{padding:16px 18px}
  dialog .footer{padding:16px 18px;border-top:1px solid #1f2937;display:flex;justify-content:space-between;gap:10px}
  label{display:block;margin:10px 0 6px}
  input,select{width:450px;max-width:100%;padding:10px 12px;border-radius:10px;background:#020617;border:1px solid #1f2937;color:#e5e7eb;display:block;margin:0 auto}
  small.help{display:block;color:#94a3b8;margin-top:2px}
  input.sample-active{color:var(--muted)}

  .form-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:10px 0}
  .form-row label{flex:0 0 180px;text-align:right}
  .form-row input,.form-row select{flex:1;margin:0}

/* === Polished compact modal styles === */
dialog{font-size:14px}
dialog header h2{font-size:16px;font-weight:600;color:var(--accent)}
.form-row{margin:6px 0}
.form-row label{flex:0 0 150px;font-size:13px;font-weight:500;color:var(--muted);text-align:right}
.form-row input,.form-row select{font-size:13px;padding:8px 10px;border-radius:8px}
small.help{font-size:11px;color:#64748b;margin-left:160px;display:block}


/* Override widths */
.form-row input,.form-row select{width:500px;max-width:100%}

.btn.small{padding:6px 10px;font-size:12px;border-radius:8px}

/* Clean Quantity Box */
#qty {
  width: 120px;
  padding: 8px 10px;
  border: 1px solid var(--ring);
  border-radius: 10px;
  background: #0b1222;
  color: var(--text);
  font-size: 14px;
  text-align: center;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
  transition: border 0.2s, box-shadow 0.2s;
}
#qty:focus {
  border: 1px solid var(--accent);
  outline: none;
  box-shadow: 0 0 0 2px rgba(34,197,94,0.3);
}


.kv {
  display: flex;
  align-items: center;
  gap: 6px; /* reduced spacing between label and input */
}
.kv b {
  margin-right: 4px;
  font-size: 14px;
}
.kv input {
  margin-left: 0;
}


.output-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}
.output-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--accent);
  text-align: center;
}


.byline {
  font-size: 13px;
  color: #94a3b8;
  font-style: italic;
}


/* Read-only look for mother fields */
.form-row input[disabled]{
  opacity: 0.7;
  cursor: not-allowed;
  background: #0a0f1d;
  border-color: #1f2937;
}


/* --- Strong no-copy/no-select for Output --- */
.out, .out * {
  user-select: none !important;
  -webkit-user-select: none !important;
  -moz-user-select: none !important;
  -ms-user-select: none !important;
  -webkit-touch-callout: none !important;
  pointer-events: none !important;
  cursor: not-allowed !important;
}


.btn.danger {
  background: linear-gradient(135deg, var(--danger), #b91c1c);
  color: #fff;
}


/* Red text for incomplete (less-than-6) child-only groups shown in UI only */
.incomplete { 
  color: #ef4444; 
  font-weight: 700; 
}



.btn.generate-btn {
  background: linear-gradient(135deg, #facc15, #eab308);
  color: #1f2937;
  font-weight: 700;
  transition: box-shadow 0.3s ease, transform 0.2s ease;
}
.btn.generate-btn:hover {
  box-shadow: 0 0 12px rgba(250, 204, 21, 0.8);
  transform: translateY(-2px);
}



.btn.download-btn {
  background: linear-gradient(135deg, #3b82f6, #2563eb); /* blue gradient */
  color: #fff;
  font-weight: 600;
  transition: box-shadow 0.3s ease, transform 0.2s ease;
}
.btn.download-btn:hover:enabled {
  box-shadow: 0 0 12px rgba(59, 130, 246, 0.8);
  transform: translateY(-2px);
}
.btn.download-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}









#editChild, #editMother {
  transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
}
#editChild:hover, #editMother:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 12px rgba(34, 197, 94, 0.7); /* green glow */
}



.kv input[type="text"] {
  width: 180px;
  padding: 8px 10px;
  border: 1px solid var(--ring);
  border-radius: 10px;
  background: #0b1222;
  color: var(--text);
  font-size: 13px;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
}
.kv input[type="text"]::placeholder {
  color: #64748b;
}


.close-btn {
  background: transparent;
  border: none;
  color: var(--muted);
  font-size: 20px;
  cursor: pointer;
  transition: color 0.2s ease;
}
.close-btn:hover {
  color: var(--danger);
}


#engName, #qcName {
  width: 140px;
  padding: 6px 8px;
  border: 1px solid var(--ring);
  border-radius: 8px;
  background: #0b1222;
  color: var(--text);
  font-size: 13px;
  text-align: left;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
  transition: border 0.2s, box-shadow 0.2s;
}
#engName:focus, #qcName:focus {
  border: 1px solid var(--accent);
  outline: none;
  box-shadow: 0 0 0 2px rgba(34,197,94,0.3);
}


:root.light {
  --bg: #f8fafc;
  --card: #ffffff;
  --muted: #475569;
  --text: #0f172a;
  --accent: #22c55e;
  --ring: #cbd5e1;
  --danger: #ef4444;
}

body.light {
  background: #f1f5f9;
  color: var(--text);
}

/* ===== Light Mode Component Overrides ===== */
body.light .card{
  background: var(--card);
  border-color: #e2e8f0;
  box-shadow: 0 10px 30px rgba(2,6,23,0.06);
}
body.light .sub{ color: var(--muted); }
body.light .byline{ color:#64748b; }

/* Buttons */
body.light .btn.secondary{
  background:#ffffff;
  border:1px solid var(--ring);
  color:#0f172a;
}
body.light .btn.ghost{
  background:transparent;
  border:1px dashed var(--ring);
  color:#64748b;
}
/* Keep gradient primaries, just adjust text color if needed */
body.light .btn.primary{ color:#052e1c; }
body.light .btn.generate-btn{ color:#1f2937; }
body.light .btn.download-btn{ color:#ffffff; }

/* Key/Value rows & dividers */
body.light .kv{ border-bottom:1px dashed #e5e7eb; }
body.light b{ color:#0f172a; }

/* Output box */
body.light .out{
  background:#ffffff;
  border-color:#e2e8f0;
  color:#0f172a;
}

/* Badge */
body.light .badge{
  background:#ffffff;
  color:#334155;
  border-color:#e2e8f0;
  box-shadow:none;
}
body.light .badge.active{
  background:#2563eb;
  color:#fff;
  box-shadow:0 0 8px rgba(59,130,246,0.5);
}

/* Dialog (modal) */
body.light dialog{
  background:#ffffff;
  color:#0f172a;
  box-shadow:0 24px 80px rgba(2,6,23,0.15);
}
body.light dialog header{
  background:linear-gradient(180deg,#f8fafc,#ffffff);
  border-bottom:1px solid #e2e8f0;
}
body.light dialog .footer{
  border-top:1px solid #e2e8f0;
}

/* Form controls */
body.light input, 
body.light select{
  background:#ffffff;
  color:#0f172a;
  border:1px solid #e2e8f0;
  box-shadow: inset 0 1px 1px rgba(2,6,23,0.04);
}
body.light input::placeholder{ color:#94a3b8; }

/* Specific fields */
body.light #qty,
body.light #engName,
body.light #qcName,
body.light .kv input[type="text"]{
  background:#ffffff;
  color:#0f172a;
  border:1px solid #e2e8f0;
  box-shadow: inset 0 1px 1px rgba(2,6,23,0.04);
}

/* Disabled read-only */
body.light .form-row input[disabled]{
  background:#f8fafc;
  border-color:#e2e8f0;
  color:#64748b;
}

/* Close button hover color remains danger */
body.light .close-btn{ color:#64748b; }
body.light .close-btn:hover{ color: var(--danger); }

/* Incomplete group color stays red; ensure contrast on light */
body.light .incomplete{ color:#b91c1c; }

/* ===== Minimalist Theme Toggle Button ===== */
.theme-toggle {
  position: fixed;
  top: 12px;
  right: 12px;
  z-index: 1000;
  font-size: 20px;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text);
  transition: transform 0.2s ease, color 0.2s ease;
}
.theme-toggle:hover {
  transform: scale(1.2);
  color: var(--accent);
}

/* ===== Required name fields highlight ===== */
  border-color: var(--danger) !important;
  box-shadow: 0 0 0 2px rgba(239,68,68,0.25) !important;
}
  font-size: 12px;
  color: var(--muted);
  margin-left: 6px;
}
  background: transparent;
  border-style: dashed;
}
/* Generic disabled state for buttons */
.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  box-shadow: none !important;
  transform: none !important;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body><button aria-label="Toggle theme" class="theme-toggle" id="themeToggle">🌙</button>
<div class="wrap">
<div class="card">
<h1>Dyson Serial Generator</h1>
<p class="sub">FOR PCB LASER MARKING<br/><span class="byline">By: Centralized Process Engineering - HQM Ionics EMS Inc.</span></p>
<div class="row" style="margin-bottom:8px">
<button class="btn primary" id="editChild">Child Serial</button>
<button class="btn primary" id="editMother">Mother Serial</button>
<button class="btn generate-btn" disabled="True" id="generate">Generate</button>
<button class="btn download-btn" disabled="" id="dlTxt">Laser File</button>
<button class="btn download-btn" disabled="" id="dlCsv">Qualified</button>
<span class="badge" id="stats">—</span>
</div>
<div class="kv"><b>Quantity (Child)</b><input id="qty" max="999" min="1" style="max-width:120px" type="number" value="0"/> <input id="engName" maxlength="17" placeholder="PE ID-Name" style="max-width:180px" type="text"/> <input id="qcName" maxlength="17" placeholder="QCE ID-Name" style="max-width:180px" type="text"/> <button class="btn danger small" id="clearOutput">Clear</button></div>
<div class="kv output-box">
<b class="output-title">Output</b>
<div class="out" id="output">—</div>
</div>
</div>
</div>
<!-- Child Modal -->
<dialog id="childModal">
<header style="display:flex;justify-content:space-between;align-items:center;">
<h2>CHILD SERIAL FORMAT <small><i>(to be validated/qualified by QCE)</i></small></h2>
<button class="close-btn" id="childClose">×</button>
</header>
<div class="body" id="childBody"></div>
<div class="footer">
<button class="btn ghost" id="childCancel">Cancel</button>
<div class="row"><button class="btn secondary" id="childReset">Reset</button><button class="btn primary" id="childSave">Save</button></div>
</div>
</dialog>
<!-- Mother Modal -->
<dialog id="motherModal">
<header style="display:flex;justify-content:space-between;align-items:center;">
<h2>MOTHER SERIAL FORMAT <small><i>(to be validated/qualified by QCE)</i></small></h2>
<button class="close-btn" id="motherClose">×</button>
</header>
<div class="body" id="motherBody"></div>
<div class="footer">
<button class="btn ghost" id="motherCancel">Cancel</button>
<div class="row"><button class="btn secondary" id="motherReset">Reset</button><button class="btn primary" id="motherSave">Save</button></div>
</div>
</dialog>
<script>
  // ====== State ======
  const C = { // Child
    AAAAAA:'846775', BB:'01', CC:'02', DD:'25', G:'E', HHHHHH:'000001', J:'B', KKKKKK:'X893--', LL:'19', MM:'01', NNNN:'2501', PP:'01', Q:'W'
  };
  const M = { // Mother
    MODEL:'X893', NAME:'POWER', VAR:'03', REV:'01', DATE:'051925', RUN:'1'
  };

  const PART_MODEL_MAP = { '846765':'USERIN', '846775':'POWER' };

  const MONTHS = {A:'January',B:'February',C:'March',D:'April',E:'May',F:'June',G:'July',H:'August',J:'September',K:'October',M:'November',N:'December'};
  const MONTH_LETTERS = ['A','B','C','D','E','F','G','H','J','K','M','N'];
  const letterToMM = (letter)=>{
    const idx = MONTH_LETTERS.indexOf(String(letter).toUpperCase());
    return idx>=0 ? String(idx+1).padStart(2,'0') : '01';
  };
  const mmToLetter = (mm)=>{
    const n = Math.max(1, Math.min(12, parseInt(mm,10)||1));
    return MONTH_LETTERS[n-1];
  };

  const SUPPLIERS = {A:'Wistron Corporation',B:'SKP BM Electronics Sdn Bhd',C:'Wistron New Web Corporation (WNC)',D:'Hi-P China',E:'Escatec',F:'Truly Optoelectronics Ltd',G:'New Vision Display Ltd',H:'Hi-P Philippines Technology Corporation',J:'Jabil Circuit (S) Pte Ltd',K:'Jabil Circuit Sdn Bhd (Jabil Penang)',M:'Microtronics Technologies Sdn Bhd',N:'Kinpo Electronics (Philippines) Inc (NKG)',P:'Flextronics Technology (Penang) Sdn Bhd',Q:'Quanta Computer Inc',R:'Yuyao Sunny Optical Intelligence Technology Co. Ltd',S:'SMT Technologies Sdn Bhd (SMTT)',T:'Flextronics Shah Alam Sdn Bhd (PTP)',U:'used in EVT1 and EVT2 run',V:'VS Electronics Sdn Bhd (VSE)',W:'VS Industry Berhad (VSI)',X:'Jabil Inc (Jabil Mexico)',Y:'Wingtech Mobile Communications Co. Ltd',Z:'Flextronics Manufacturing (Zhuhai) Co. Ltd'};
  const BARE = {U:'Unitech',Y:'Yan Tat',W:'Olympics',K:'KCE','-':'OEM (not Dyson bare board)'};

  // ====== UI Builders ======
  function field(label, id, val, help=''){
  return `
    <div class="form-row">
      <label for="${id}">${label}</label>
      <input id="${id}" value="${val}" data-sample="${val}" class="sample-active">
    </div>
    ${help?`<small class='help'>${help}</small>`:''}
  `;
}
  function select(label,id,opts,val,help=''){
  const options = Object.entries(opts).map(([k,v])=>`<option value="${k}" ${k===val?'selected':''}>${k} — ${v}</option>`).join('');
  return `
    <div class="form-row">
      <label for='${id}'>${label}</label>
      <select id='${id}'>${options}</select>
    </div>
    ${help?`<small class='help'>${help}</small>`:''}
  `;
}

  // Disabled input helper (for read-only fields)
  function dfield(label, id, val, help=''){
    return `
      <div class="form-row">
        <label for="${id}">${label}</label>
        <input id="${id}" value="${val}" data-sample="${val}" class="sample-active" disabled>
      </div>
      ${help?`<small class='help'>${help}</small>`:''}
    `;
  }

  function childForm(){
    return [
      select('Part Number (6 digits, left‑pad 0)','c_AAAAAA',{ '846765':'USER INTERFACE','846775':'POWER' },C.AAAAAA,'Choose part number'),
      field('Variance (2)','c_BB',C.BB),
      field('Revision (2)','c_CC',C.CC),
      field('Year (YY)','c_DD',C.DD),
      select('Manufacturing Month','c_G',MONTHS,C.G,'A=Jan, B=Feb, C=Mar, D=Apr, E=May, F=Jun, G=Jul, H=Aug, J=Sep, K=Oct, M=Nov, N=Dec'),
      field('Child start run (enter 1; outputs 6-digit)','c_H',C.HHHHHH),
      select('PCBA Supplier','c_J',SUPPLIERS,C.J,'Saving letter code; label shows supplier name'),
      field('Model (right‑pad "-" to 6)','c_K',C.KKKKKK),
      field('Day (2)','c_LL',C.LL),
      field('Config (2)','c_MM',C.MM),
      field('BareBoard Date (4)','c_N',C.NNNN),
      select('Bare board manufacturer','c_Q',BARE,C.Q,'Choose “-” for bought‑out OEM PCBAs')
    ].join('');
  }
  function motherForm(){
    return [
      dfield('Model Number','m_MODEL',M.MODEL),
      dfield('Model Name','m_NAME',M.NAME),
      dfield('Variance (2)','m_VAR',M.VAR),
      dfield('Revision (2)','m_REV',M.REV),
      dfield('Date (MMDDYY)','m_DATE',M.DATE,'Use Auto‑fill to set today (MMDDYY)'),
      field('Start Run','m_RUN',M.RUN,'Mother run increments per 6‑child group; two identical mother lines per group')
    ].join('');
  }

  
  function retagSamples(containerId){
    const el = document.getElementById(containerId);
    if(!el) return;
    el.querySelectorAll('input[data-sample]').forEach(inp=>{
      const sample = inp.getAttribute('data-sample') || '';
      if (inp.value === sample || inp.value.trim()===''){
        inp.value = sample;
        inp.classList.add('sample-active');
      }
    });
  }


  
  // ====== Child-to-Mother live date sync ======
  function syncMotherDateFromChild() {
    try {
      const ddEl = document.getElementById('c_DD');
      const gEl  = document.getElementById('c_G');
      const llEl = document.getElementById('c_LL');
      if (!ddEl || !gEl || !llEl) return; // not rendered yet
      const yy = String(ddEl.value || '').padStart(2,'0');
      const mm = letterToMM(gEl.value || 'A');
      const dd = String(llEl.value || '').padStart(2,'0');
      M.DATE = `${mm}${dd}${yy}`;
      renderMother();
    } catch(e) { console.warn("Live sync Child→Mother failed", e); }
  }

  // Listen to changes on Child date fields
  document.addEventListener('input', (e)=>{
    if (e && e.target && ['c_DD','c_G','c_LL'].includes(e.target.id)) {
      syncMotherDateFromChild();
    }
  });


  // ====== Serial Builders ======
  const pad = (s,l,ch='0')=>String(s).toUpperCase().padStart(l,ch);
  function buildChild(i){
    const run = pad(parseInt(C.HHHHHH,10)+i,6,'0');
    return `${pad(C.AAAAAA,6,'0')}${pad(C.BB,2,'0')}${pad(C.CC,2,'0')}${pad(C.DD,2,'0')}${C.G}${run}${C.J}${pad(C.KKKKKK,6,'-')}${pad(C.LL,2,'0')}${pad(C.MM,2,'0')}${pad(C.NNNN,4,'0')}${pad(C.PP||'01',2,'0')}${C.Q}`;
  }
  function buildMother(groupIndex){
    const run = pad(parseInt(M.RUN,10)+groupIndex,6,'0');
    return `${M.MODEL.replace(/-/g,'')}${M.NAME}${pad(M.VAR,2,'0')}${pad(M.REV,2,'0')}${M.DATE}${run}`;
  }

  // ====== Generate & Download ======
  function generate(){
    const raw = parseInt(document.getElementById('qty').value) || 0;
    const qty = Math.max(0, Math.min(999, raw)); // allow 0
    const totalGroups = Math.ceil(qty / 6);

    const lines = [];        // only complete groups -> used for download
    const displayLines = []; // what we show in the Output box
    let made = 0;
    let completeGroups = 0;

    for (let g = 0; g < totalGroups; g++) {
      const remaining = qty - made;
      const inGroup = Math.min(6, remaining);
      const children = [];

      for (let i = 0; i < inGroup; i++) {
        const child = buildChild(made++);
        children.push(child);
      }

      if (inGroup === 6) {
        // Complete group -> include in both display and download
        displayLines.push(...children);
        const m = buildMother(g);
        displayLines.push(m, m);
        lines.push(...children, m, m);
        completeGroups++;
      } else if (inGroup > 0) {
        // Incomplete group -> display children in red, skip mother entirely
        children.forEach(c => displayLines.push(`<span class="incomplete">${c}</span>`));
      }
    }

    // Render to output (use innerHTML to honor <span class="incomplete">)
    const outEl = document.getElementById('output');
    outEl.innerHTML = displayLines.length ? displayLines.join('\n') : '—';

    // Update downloads & stats
    const hasDownload = lines.length > 0;
    document.getElementById('dlTxt').disabled = !(hasDownload && namesFilled && namesFilled());
    document.getElementById('dlCsv').disabled = !(hasDownload && namesFilled && namesFilled());
    document.getElementById('stats').textContent = hasDownload ? `${lines.length} lines • ${completeGroups} group(s)` : '—';

    // Toggle badge active state based on download availability
    const badge = document.getElementById('stats');
    if (badge) {
      if (hasDownload) {
        badge.classList.add('active');
      } else {
        badge.classList.remove('active');
      }
    }


    // Expose for download functions
    window.__lines = lines;
    window.__groups = completeGroups;
    window.__qty = completeGroups * 6; // only complete groups count for downloads
  }



  function downloadTxt(){
    const lines = window.__lines||[]; if(!lines.length) return;
    const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; const modelName = (M.NAME || 'DysonModel').replace(/[^A-Za-z0-9_-]/g,'');
    
    const t1 = new Date();
    const dstr1 = String(t1.getFullYear()) + String(t1.getMonth()+1).padStart(2,'0') + String(t1.getDate()).padStart(2,'0');
    a.download = 'Laser_' + modelName + '_' + dstr1 + '.txt'; a.click(); URL.revokeObjectURL(url);
  }
  function downloadCsv(){
    const lines = window.__lines||[]; if(!lines.length) return;
const engName = (document.getElementById('engName')?.value || '').replaceAll('"','""');
const qcName  = (document.getElementById('qcName')?.value || '').replaceAll('"','""');
    const rows = [`Serial Generated by,"${engName}"`,`Validated/Qualified by,"${qcName}"`,'Type,Serial'];
    let idx=0, made=0; const groups = window.__groups||Math.ceil((window.__qty||0)/6);
    for(let g=0; g<groups; g++){
      const inGroup = Math.min(6, (window.__qty||0)-made);
      for(let i=0;i<inGroup;i++){ rows.push(`"Child","${lines[idx++]}"`); made++; }
      rows.push(`"Mother","${lines[idx++]}"`);
      rows.push(`"Mother","${lines[idx++]}"`);
    }
    const blob = new Blob([rows.join('\r\n')], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; const modelName = (M.NAME || 'DysonModel').replace(/[^A-Za-z0-9_-]/g,'');
    
    const t2 = new Date();
    const dstr2 = String(t2.getFullYear()) + String(t2.getMonth()+1).padStart(2,'0') + String(t2.getDate()).padStart(2,'0');
    a.download = 'Qualified_' + modelName + '_' + dstr2 + '.csv'; a.click(); URL.revokeObjectURL(url);
  }

  
  // ====== Sample text behavior (clear on click, restore on blur) ======
  document.addEventListener('focusin', (e)=>{
    if (e.target instanceof HTMLInputElement && e.target.hasAttribute('data-sample')){
      const sample = e.target.getAttribute('data-sample') || '';
      if (e.target.value === sample){
        e.target.value = '';
        e.target.classList.remove('sample-active');
      }
    }
  });
  document.addEventListener('focusout', (e)=>{
    if (e.target instanceof HTMLInputElement && e.target.hasAttribute('data-sample')){
      const sample = e.target.getAttribute('data-sample') || '';
      if (e.target.value.trim() === ''){
        e.target.value = sample;
        e.target.classList.add('sample-active');
      }
    }
  });


  
  // ====== Live sync between Child PN and Mother NAME ======
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.id === 'c_AAAAAA') {
      const pn = e.target.value;
      if (PART_MODEL_MAP[pn]){
        M.NAME = PART_MODEL_MAP[pn];
        renderMother();
      }
    }
  });
  document.addEventListener('input', (e)=>{
    if (e.target && e.target.id === 'm_NAME') {
      const nameNorm = (e.target.value||'').toUpperCase().trim();
      for (const [pn, nm] of Object.entries(PART_MODEL_MAP)) {
        if (nameNorm === String(nm).toUpperCase()) {
          C.AAAAAA = pn;
          renderChild();
          break;
        }
      }
    }
  });


  
  // ====== Live sync VAR/REV between Child and Mother ======
  document.addEventListener('input', (e)=>{
    // Child -> Mother
    if (e.target && (e.target.id === 'c_BB' || e.target.id === 'c_CC')){
      try {
        if (e.target.id === 'c_BB') M.VAR = (e.target.value || '').toString().padStart(2,'0');
        if (e.target.id === 'c_CC') M.REV = (e.target.value || '').toString().padStart(2,'0');
        renderMother();
      } catch(err){ console.warn('Live sync to Mother VAR/REV failed', err); }
    }
    // Mother -> Child
    if (e.target && (e.target.id === 'm_VAR' || e.target.id === 'm_REV')){
      try {
        if (e.target.id === 'm_VAR') C.BB = (e.target.value || '').toString().padStart(2,'0');
        if (e.target.id === 'm_REV') C.CC = (e.target.value || '').toString().padStart(2,'0');
        renderChild();
      } catch(err){ console.warn('Live sync to Child BB/CC failed', err); }
    }
  });


  // ====== Modal Wiring ======
  const childModal=document.getElementById('childModal');
  const motherModal=document.getElementById('motherModal');
  function renderChild(){ document.getElementById('childBody').innerHTML = childForm(); retagSamples('childBody'); }
  function renderMother(){ document.getElementById('motherBody').innerHTML = motherForm(); retagSamples('motherBody'); }
  renderChild(); renderMother();

  // Open
  document.getElementById('editChild').addEventListener('click', ()=> childModal.showModal());
  document.getElementById('editMother').addEventListener('click', ()=> motherModal.showModal());

  // Save handlers
  document.getElementById('childSave').addEventListener('click', ()=>{
    C.AAAAAA=document.getElementById('c_AAAAAA').value; C.BB=document.getElementById('c_BB').value; C.CC=document.getElementById('c_CC').value;
    C.DD=document.getElementById('c_DD').value; C.G=document.getElementById('c_G').value; C.HHHHHH = String(parseInt(document.getElementById('c_H').value||'0',10)||0);
    C.J=document.getElementById('c_J').value; C.KKKKKK=document.getElementById('c_K').value; C.LL=document.getElementById('c_LL').value;
    C.MM=document.getElementById('c_MM').value; C.NNNN=document.getElementById('c_N').value; C.Q=document.getElementById('c_Q').value;
    
    
    // --- Sync Mother NAME from Child Part Number (mapping)
    try {
      if (PART_MODEL_MAP[C.AAAAAA]) {
        M.NAME = PART_MODEL_MAP[C.AAAAAA];
        renderMother();
      }
    } catch(e){ console.warn('Sync Mother NAME from Child PN failed', e); }
    // --- Sync Mother DATE (MMDDYY) from Child date (YY + month letter + DD)
    try {
      const mm = letterToMM(C.G);
      const dd = String(C.LL||'').padStart(2,'0');
      const yy = String(C.DD||'').padStart(2,'0');
      M.DATE = `${mm}${dd}${yy}`;
      renderMother();
    } catch(e){ console.warn('Sync Mother from Child failed', e); }

    // --- Sync Mother VAR/REV from Child BB/CC
    try {
      M.VAR = (C.BB || M.VAR || '').toString().padStart(2,'0');
      M.REV = (C.CC || M.REV || '').toString().padStart(2,'0');
      renderMother();
    } catch(e){ console.warn('Sync Mother VAR/REV from Child BB/CC failed', e); }
    childModal.close(); generate();
  });
  document.getElementById('motherSave').addEventListener('click', ()=>{
    M.MODEL=document.getElementById('m_MODEL').value; M.NAME=document.getElementById('m_NAME').value; M.VAR=document.getElementById('m_VAR').value;
    M.REV=document.getElementById('m_REV').value; M.DATE=document.getElementById('m_DATE').value; M.RUN=document.getElementById('m_RUN').value;
    
    
    // --- Sync Child Part Number from Mother NAME (reverse mapping)
    try {
      const nameNorm = (M.NAME||'').toUpperCase().trim();
      for (const [pn, nm] of Object.entries(PART_MODEL_MAP)) {
        if (nameNorm === String(nm).toUpperCase()) {
          C.AAAAAA = pn;
          renderChild();
          break;
        }
      }
    } catch(e){ console.warn('Sync Child PN from Mother NAME failed', e); }
    // --- Sync Child date (YY + month letter + DD) from Mother DATE (MMDDYY)
    try {
      const dateStr = String(M.DATE||'');
      const mm = dateStr.slice(0,2) || '01';
      const dd = dateStr.slice(2,4) || '01';
      const yy = dateStr.slice(4,6) || '00';
      C.DD = yy;
      C.G  = mmToLetter(mm);
      C.LL = dd;
      renderChild();
    } catch(e){ console.warn('Sync Child from Mother failed', e); }
motherModal.close(); generate();
  });

  // Cancel & Reset
  document.getElementById('childCancel').addEventListener('click', ()=> childModal.close());
  document.getElementById('motherCancel').addEventListener('click', ()=> motherModal.close());
  document.getElementById('childReset').addEventListener('click', renderChild);
  document.getElementById('motherReset').addEventListener('click', renderMother);

  

// Close buttons
document.getElementById('childClose').addEventListener('click', ()=> childModal.close());
document.getElementById('motherClose').addEventListener('click', ()=> motherModal.close());

  // Other controls
  document.getElementById('generate').addEventListener('click', generate);
  document.getElementById('dlTxt').addEventListener('click', downloadTxt);
  // Initial render
  generate();

  // --- Hard block copy/select on Output ---
  (function(){
    const out = document.getElementById('output');
    if (out) {
      ['copy','cut','contextmenu','selectstart','dragstart'].forEach(ev => {
        out.addEventListener(ev, e => { e.preventDefault(); return false; });
      });
    }
  })();


  
  // --- Clear Output Button ---
  document.getElementById('clearOutput').addEventListener('click', ()=>{
    document.getElementById('qty').value = '';  // reset qty input
    document.getElementById('output').textContent = '—';
    document.getElementById('dlTxt').disabled = true;
    document.getElementById('dlCsv').disabled = true;
    document.getElementById('stats').textContent = '—';
  });



// --- Minimalist Theme Toggle ---
const themeToggle = document.getElementById('themeToggle');

if (localStorage.getItem('theme') === 'light') {
  document.documentElement.classList.add('light');
  document.body.classList.add('light');
  themeToggle.textContent = '☀️';
}

themeToggle.addEventListener('click', () => {
  const isLight = document.documentElement.classList.toggle('light');
  document.body.classList.toggle('light', isLight);
  themeToggle.textContent = isLight ? '☀️' : '🌙';
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
});


// === Require names before allowing downloads (simplified) ===
function namesFilled(){
  const eng = (document.getElementById('engName')?.value || '').trim();
  const qc  = (document.getElementById('qcName')?.value || '').trim();
  return eng.length > 0 && qc.length > 0;
}

function updateDownloadButtons(){
  const dlTxt = document.getElementById('dlTxt');
  const dlCsv = document.getElementById('dlCsv');
  const hasLines = (window.__lines || []).length > 0;
  const ok = hasLines && namesFilled();
  dlTxt.disabled = !ok;
  dlCsv.disabled = !ok;
}

// Hook into existing generate() to enforce validation
(function(){
  const _generate = generate;
  generate = function(){
    _generate();
    updateDownloadButtons();
  };
})();

// Live validation while typing
['engName','qcName','qty'].forEach(id=>{
  const el = document.getElementById(id);
  if(el){
    el.addEventListener('input', ()=> updateDownloadButtons());
  }
});

// Guard clicks on download buttons
['dlTxt','dlCsv'].forEach(id=>{
  const btn = document.getElementById(id);
  if(btn){
    btn.addEventListener('click', (e)=>{
      if(!namesFilled()){
        e.preventDefault();
        return false;
      }
    });
  }
});

// Run once on load
updateDownloadButtons();

// === Hard guard: block download functions when names missing ===
(function(){
  const _downloadTxt = downloadTxt;
  const _downloadCsv = downloadCsv;
  window.downloadTxt = function(){
    if (!namesFilled()) { return; }
    _downloadTxt();
  };
  window.downloadCsv = function(){
    if (!namesFilled()) { return; }
    _downloadCsv();
  };
})();

// === Generate requires names filled ===
function updateGenerateButton(){
  const gen = document.getElementById('generate');
  if(gen){ gen.disabled = !namesFilled(); }
}

// Replace generate with a guarded version
(function(){
  const _generate = generate;
  generate = function(){
    if(!namesFilled()){ return; }
    _generate();
    updateDownloadButtons && updateDownloadButtons();
  };
})();

// Live check for name inputs
['engName','qcName'].forEach(id=>{
  const el = document.getElementById(id);
  if(el){
    el.addEventListener('input', ()=>{
      updateGenerateButton();
      updateDownloadButtons && updateDownloadButtons();
    });
  }
});

// Initial state on load
updateGenerateButton();

// === Updated name rules ===
// peFilled: only Process Engineer required
function peFilled(){
  const eng = (document.getElementById('engName')?.value || '').trim();
  return eng.length > 0;
}
// namesFilled: both Process Engineer and QCE required
function namesFilled(){
  const eng = (document.getElementById('engName')?.value || '').trim();
  const qc  = (document.getElementById('qcName')?.value || '').trim();
  return eng.length > 0 && qc.length > 0;
}

// Enable Generate if PE is filled. Enable downloads if BOTH names + lines exist.
function updateGenerateButton(){
  const gen = document.getElementById('generate');
  if(gen){ gen.disabled = !peFilled(); }
}
function updateDownloadButtons(){
  const dlTxt = document.getElementById('dlTxt');
  const dlCsv = document.getElementById('dlCsv');
  const hasLines = (window.__lines || []).length > 0;
  const ok = hasLines && namesFilled();
  if(dlTxt) dlTxt.disabled = !ok;
  if(dlCsv) dlCsv.disabled = !ok;
}

// Guard generate: require PE name
(function(){
  const _generate = generate;
  generate = function(){
    if(!peFilled()){ return; }
    _generate();
    updateDownloadButtons && updateDownloadButtons();
  };
})();

// Keep hard guards on downloads (if previously added); otherwise add them now.
if (typeof window.downloadTxt === 'function') {
  (function(){
    const _downloadTxt = downloadTxt;
    const _downloadCsv = downloadCsv;
    window.downloadTxt = function(){
      if (!namesFilled()) { return; }
      _downloadTxt();
    };
    window.downloadCsv = function(){
      if (!namesFilled()) { return; }
      _downloadCsv();
    };
  })();
}

// Live checks
['engName','qcName','qty'].forEach(id=>{
  const el = document.getElementById(id);
  if(el){
    el.addEventListener('input', ()=>{
      updateGenerateButton();
      updateDownloadButtons && updateDownloadButtons();
    });
  }
});

// Initial state
updateGenerateButton();
updateDownloadButtons && updateDownloadButtons();


// === FINAL SAFETY: prevent downloads without both names ===
(function(){
  const txtBtn = document.getElementById('dlTxt');
  const csvBtn = document.getElementById('dlCsv');
  function blockIfMissing(e){
    if(!(typeof namesFilled==='function' && namesFilled())){
      e.preventDefault();
      return false;
    }
  }
  if(txtBtn){ txtBtn.addEventListener('click', blockIfMissing, true); }
  if(csvBtn){ csvBtn.addEventListener('click', blockIfMissing, true); }
})();

// === Strict ID rules: 6 digits only and not equal ===
function onlyDigitsAndLimit(el){
  if(!el) return;
  const cleaned = (el.value || '').replace(/\D+/g, '').slice(0,6);
  if(el.value !== cleaned){ el.value = cleaned; }
}

function peValid(){
  const v = (document.getElementById('engName')?.value || '').trim();
  return /^\d{6}$/.test(v);
}
function qcValid(){
  const v = (document.getElementById('qcName')?.value || '').trim();
  return /^\d{6}$/.test(v);
}
function idsDistinct(){
  const pe = (document.getElementById('engName')?.value || '').trim();
  const qc = (document.getElementById('qcName')?.value || '').trim();
  return pe !== '' && qc !== '' ? pe !== qc : true;
}
function bothValidDistinct(){
  return peValid() && qcValid() && idsDistinct();
}

// Override previous helpers to use strict rules
function namesFilled(){ return bothValidDistinct(); }
function peFilled(){ return peValid(); }

function updateGenerateButton(){
  const gen = document.getElementById('generate');
  if(gen){ gen.disabled = !peValid(); }
}

function updateDownloadButtons(){
  const dlTxt = document.getElementById('dlTxt');
  const dlCsv = document.getElementById('dlCsv');
  const hasLines = (window.__lines || []).length > 0;
  const ok = hasLines && bothValidDistinct();
  if(dlTxt) dlTxt.disabled = !ok;
  if(dlCsv) dlCsv.disabled = !ok;
}

// Hard-guard downloads
(function(){
  const _txt = window.downloadTxt;
  const _csv = window.downloadCsv;
  window.downloadTxt = function(){
    if(!bothValidDistinct()) return;
    _txt();
  };
  window.downloadCsv = function(){
    if(!bothValidDistinct()) return;
    _csv();
  };
})();

// Enforce numeric input on the fly
['engName','qcName'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  ['input','change','paste'].forEach(evt=>{
    el.addEventListener(evt, ()=>{
      onlyDigitsAndLimit(el);
      updateGenerateButton();
      updateDownloadButtons && updateDownloadButtons();
    });
  });
});

// Initial run
onlyDigitsAndLimit(document.getElementById('engName'));
onlyDigitsAndLimit(document.getElementById('qcName'));
updateGenerateButton();
updateDownloadButtons && updateDownloadButtons();

// === Strict ID format: 6 digits + dash + 1-10 letters ===
// Regex: ^\d{6}-[A-Za-z]{1,10}$

function cleanAndFormatID(el){
  if(!el) return;
  let raw = (el.value || '').toUpperCase();
  // Remove invalid chars
  raw = raw.replace(/[^0-9A-Z-]/g, '');
  // Split digits and letters
  let digits = raw.replace(/[^0-9]/g, '').slice(0,6);
  let letters = raw.replace(/[^A-Z]/g, '').slice(0,10);
  if(digits.length === 6){
    el.value = letters.length > 0 ? digits + '-' + letters : digits + '-';
  } else {
    el.value = digits;
  }
}

function peValid(){
  const v = (document.getElementById('engName')?.value || '').trim();
  return /^\d{6}-[A-Z]{1,10}$/.test(v);
}
function qcValid(){
  const v = (document.getElementById('qcName')?.value || '').trim();
  return /^\d{6}-[A-Z]{1,10}$/.test(v);
}
function idsDistinct(){
  const pe = (document.getElementById('engName')?.value || '').trim();
  const qc = (document.getElementById('qcName')?.value || '').trim();
  return pe !== '' && qc !== '' ? pe !== qc : true;
}
function bothValidDistinct(){
  return peValid() && qcValid() && idsDistinct();
}

// Override namesFilled/peFilled
function namesFilled(){ return bothValidDistinct(); }
function peFilled(){ return peValid(); }

function updateGenerateButton(){
  const gen = document.getElementById('generate');
  if(gen){ gen.disabled = !peValid(); }
}
function updateDownloadButtons(){
  const dlTxt = document.getElementById('dlTxt');
  const dlCsv = document.getElementById('dlCsv');
  const hasLines = (window.__lines || []).length > 0;
  const ok = hasLines && bothValidDistinct();
  if(dlTxt) dlTxt.disabled = !ok;
  if(dlCsv) dlCsv.disabled = !ok;
}

// Hard-guard downloads
(function(){
  const _txt = window.downloadTxt;
  const _csv = window.downloadCsv;
  window.downloadTxt = function(){
    if(!bothValidDistinct()) return;
    _txt();
  };
  window.downloadCsv = function(){
    if(!bothValidDistinct()) return;
    _csv();
  };
})();

// Auto-format while typing
['engName','qcName'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  ['input','change','paste'].forEach(evt=>{
    el.addEventListener(evt, ()=>{
      cleanAndFormatID(el);
      updateGenerateButton();
      updateDownloadButtons && updateDownloadButtons();
    });
  });
});

// Initial run
cleanAndFormatID(document.getElementById('engName'));
cleanAndFormatID(document.getElementById('qcName'));
updateGenerateButton();
updateDownloadButtons && updateDownloadButtons();


// === Corrected auto-format to allow letters after dash ===
function cleanAndFormatID(el){
  if(!el) return;
  let raw = (el.value || '').toUpperCase();

  // Keep only digits, dash, letters
  raw = raw.replace(/[^0-9A-Z-]/g, '');

  // If dash missing and we have 6 digits, insert it
  if (/^\d{6}$/.test(raw)) {
    raw = raw + '-';
  }

  // Split around first dash
  const parts = raw.split('-', 2);
  let digits = parts[0].replace(/[^0-9]/g, '').slice(0,6);
  let letters = (parts.length > 1 ? parts[1] : '').replace(/[^A-Z]/g, '').slice(0,10);

  // Recompose
  if (digits.length === 6) {
    raw = letters.length ? digits + '-' + letters : digits + (raw.includes('-') ? '-' : '');
  } else {
    raw = digits; // before 6 digits, no dash or letters yet
  }

  el.value = raw;
}


// === FINAL corrected auto-format: 6 digits, auto-dash, then 1-10 letters ===
function cleanAndFormatID(el){
  if(!el) return;
  let raw = (el.value || '').toUpperCase();

  // Keep only digits and letters while typing
  raw = raw.replace(/[^0-9A-Z]/g, '');

  // First up to 6 digits
  let digits = raw.replace(/[^0-9]/g, '').slice(0, 6);

  // Letters allowed only after the first 6 chars the user entered
  let rest = '';
  if (raw.length > 6) {
    rest = raw.slice(6).replace(/[^A-Z]/g, '').slice(0, 10);
  }

  // Recompose with auto dash once we have 6 digits
  if (digits.length === 6) {
    el.value = rest.length ? digits + '-' + rest : digits + '-';
  } else {
    el.value = digits;
  }
}

// === Robust formatter: keep dash, allow letters after it ===
function cleanAndFormatID(el){
  if(!el) return;
  let v = (el.value || '').toUpperCase();
  // Allow only digits, letters, single dash
  v = v.replace(/[^0-9A-Z-]/g, '');
  // Keep only first dash if multiple
  const firstDash = v.indexOf('-');
  if (firstDash !== -1) {
    v = v.slice(0, firstDash + 1) + v.slice(firstDash + 1).replace(/-/g, '');
  }
  // Split into parts
  let parts = v.split('-', 2);
  let digits = (parts[0] || '').replace(/[^0-9]/g, '').slice(0, 6);
  let letters = parts.length > 1 ? (parts[1] || '').replace(/[^A-Z]/g, '').slice(0, 10) : '';
  // Compose with auto-dash after 6 digits
  if (digits.length === 6) {
    el.value = letters.length ? digits + '-' + letters : digits + '-';
  } else {
    el.value = digits; // No dash until 6 digits
  }
}


// ==== FINAL PATCH: allow letters after dash, validate, and wire events ====
function cleanAndFormatID(el){
  if(!el) return;
  let v = (el.value || '').toUpperCase();

  // Keep digits, letters, dash only
  v = v.replace(/[^0-9A-Z-]/g, '');

  // Only one dash allowed (keep first)
  const firstDash = v.indexOf('-');
  if (firstDash !== -1) {
    v = v.slice(0, firstDash + 1) + v.slice(firstDash + 1).replace(/-/g, '');
  }

  // Split and constrain
  const parts = v.split('-', 2);
  const digits = (parts[0] || '').replace(/[^0-9]/g, '').slice(0,6);
  const letters = parts.length > 1 ? (parts[1] || '').replace(/[^A-Z]/g, '').slice(0,10) : '';

  // Recompose
  if (digits.length === 6) {
    el.value = digits + '-' + letters;
  } else {
    el.value = digits; // no dash/letters until 6 digits present
  }
}

// Validators for new format: 6 digits + dash + 1-10 letters
function peValid(){
  const v = (document.getElementById('engName')?.value || '').trim().toUpperCase();
  return /^\d{6}-[A-Z]{1,10}$/.test(v);
}
function qcValid(){
  const v = (document.getElementById('qcName')?.value || '').trim().toUpperCase();
  return /^\d{6}-[A-Z]{1,10}$/.test(v);
}
function idsDistinct(){
  const pe = (document.getElementById('engName')?.value || '').trim().toUpperCase();
  const qc = (document.getElementById('qcName')?.value || '').trim().toUpperCase();
  return pe && qc ? pe !== qc : true;
}
function bothValidDistinct(){ return peValid() && qcValid() && idsDistinct(); }

// Update buttons using latest rules
function updateGenerateButton(){
  const gen = document.getElementById('generate');
  if(gen){ gen.disabled = !peValid(); }
}
function updateDownloadButtons(){
  const dlTxt = document.getElementById('dlTxt');
  const dlCsv = document.getElementById('dlCsv');
  const hasLines = (window.__lines || []).length > 0;
  const ok = hasLines && bothValidDistinct();
  if(dlTxt) dlTxt.disabled = !ok;
  if(dlCsv) dlCsv.disabled = !ok;
}

// Hard-guard downloads
(function(){
  const _txt = window.downloadTxt;
  const _csv = window.downloadCsv;
  window.downloadTxt = function(){
    if(!bothValidDistinct()) return;
    _txt();
  };
  window.downloadCsv = function(){
    if(!bothValidDistinct()) return;
    _csv();
  };
})();

// Rebind events for both inputs (input/change/paste)
(function(){
  const ids = ['engName','qcName'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    ['input','change','paste'].forEach(evt=>{
      el.addEventListener(evt, ()=>{
        cleanAndFormatID(el);
        updateGenerateButton();
        if(typeof updateDownloadButtons==='function') updateDownloadButtons();
      });
    });
    // Initial clean
    cleanAndFormatID(el);
  });
  // Initial state
  updateGenerateButton();
  if(typeof updateDownloadButtons==='function') updateDownloadButtons();
})();

// ==== ULTRA-GUARD PATCH ====
// 1) Neutralize any old numeric-only sanitizer
window.onlyDigitsAndLimit = function(){ /* disabled */ };

// 2) Final formatter (kept)
function cleanAndFormatID(el){
  if(!el) return;
  let v = (el.value || '').toUpperCase();
  v = v.replace(/[^0-9A-Z-]/g, '');
  const firstDash = v.indexOf('-');
  if (firstDash !== -1) {
    v = v.slice(0, firstDash + 1) + v.slice(firstDash + 1).replace(/-/g, '');
  }
  const parts = v.split('-', 2);
  const digits = (parts[0] || '').replace(/[^0-9]/g, '').slice(0,6);
  const letters = parts.length > 1 ? (parts[1] || '').replace(/[^A-Z]/g, '').slice(0,10) : '';
  if (digits.length === 6) {
    el.value = digits + '-' + letters;
  } else {
    el.value = digits;
  }
}

// 3) Capture-phase handlers that block earlier listeners from stripping letters
(function attachStrongHandlers(){
  ['engName','qcName'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;

    // Remove inline handlers if any
    el.oninput = null; el.onchange = null; el.onpaste = null; el.onkeydown = null;

    // Keydown: allow letters after dash; always uppercase
    el.addEventListener('keydown', function(e){
      // Allow control keys
      if (['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'].includes(e.key)) return;
      const val = el.value.toUpperCase();
      const dashAt = val.indexOf('-');
      const cursor = el.selectionStart;
      // Before 6 digits: only digits allowed
      if (dashAt === -1 || cursor <= dashAt) {
        if (!/^[0-9]$/.test(e.key)) { e.preventDefault(); }
      } else {
        // After dash: only letters allowed
        if (!/^[A-Z]$/.test(e.key)) { e.preventDefault(); }
      }
    }, true); // capture

    // Input/change/paste: stop other listeners, then format
    ['input','change','paste'].forEach(evt=>{
      el.addEventListener(evt, function(e){
        if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
        cleanAndFormatID(el);
        if (typeof updateGenerateButton==='function') updateGenerateButton();
        if (typeof updateDownloadButtons==='function') updateDownloadButtons();
      }, true); // capture
    });

    // Initial normalize
    cleanAndFormatID(el);
  });
})();


// === RULE UPDATE: First 6 digits (before dash) must NOT match between PE and QCE ===
function firstSixDigitsDifferent(){
  const pe = (document.getElementById('engName')?.value || '').toUpperCase();
  const qc = (document.getElementById('qcName')?.value || '').toUpperCase();
  const pe6 = (pe.split('-')[0] || '').slice(0,6);
  const qc6 = (qc.split('-')[0] || '').slice(0,6);
  if (pe6.length < 6 || qc6.length < 6) return true; // don't block while incomplete
  return pe6 !== qc6;
}

// Override idsDistinct to use first 6-digit comparison AND full-string inequality (extra safety)
function idsDistinct(){
  const peVal = (document.getElementById('engName')?.value || '').toUpperCase();
  const qcVal = (document.getElementById('qcName')?.value || '').toUpperCase();
  // Must be different in first 6 digits, and overall not identical
  return firstSixDigitsDifferent() && (peVal === '' || qcVal === '' || peVal !== qcVal);
}

// Recalculate "bothValidDistinct" with the new rule
function bothValidDistinct(){
  return peValid() && qcValid() && idsDistinct();
}

// Re-evaluate buttons on input
(function(){
  ['engName','qcName'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', ()=>{
      if (typeof updateGenerateButton==='function') updateGenerateButton();
      if (typeof updateDownloadButtons==='function') updateDownloadButtons();
    }, true);
  });
  if (typeof updateGenerateButton==='function') updateGenerateButton();
  if (typeof updateDownloadButtons==='function') updateDownloadButtons();
})();
</script>
<div style="position:fixed; bottom:10px; left:10px;
            font-size:12px; color:#555; user-select:none; text-align:left;">
  © JAY.T 2025
</div>

<script>
// === Tooltip for disabled Generate button ===
(function(){
  const genBtn = document.getElementById('generate');
  if(!genBtn) return;

  // Create tooltip element
  const tip = document.createElement('div');
  tip.textContent = 'Input PE ID and name first';
  Object.assign(tip.style, {
    position:'fixed', padding:'6px 10px', borderRadius:'8px',
    background:'rgba(220,38,38,0.95)', color:'#e5e7eb', fontSize:'12px',
    boxShadow:'0 6px 20px rgba(0,0,0,0.35)', zIndex: 10000, pointerEvents:'none',
    opacity:'0', transform:'translateY(6px)', transition:'opacity .12s ease, transform .12s ease'
  });
  document.body.appendChild(tip);

  function showTip(e){
    if (!genBtn.disabled) return; // only show when disabled
    const r = genBtn.getBoundingClientRect();
    tip.style.left = (r.left + (r.width/2) - (tip.offsetWidth/2)) + 'px';
    tip.style.top  = (r.top - 10 - tip.offsetHeight) + 'px';
    tip.style.opacity = '1';
    tip.style.transform = 'translateY(0)';
  }
  function hideTip(){
    tip.style.opacity = '0';
    tip.style.transform = 'translateY(6px)';
  }

  // Hover/focus listeners
  ['mouseenter','focus'].forEach(ev => genBtn.addEventListener(ev, showTip));
  ['mouseleave','blur','click'].forEach(ev => genBtn.addEventListener(ev, hideTip));

  // Recompute position if window resizes while shown
  window.addEventListener('resize', ()=>{
    if (tip.style.opacity === '1') showTip();
  });

  // Hook into your existing updater so tooltip tracks enabled/disabled state
  const _updateGenerateButton = window.updateGenerateButton;
  window.updateGenerateButton = function(){
    if (typeof _updateGenerateButton === 'function') _updateGenerateButton();
    // If it just became enabled while tip is visible, hide it
    if (!genBtn.disabled) hideTip();
  };
})();
</script>


<script>
// === Tooltip for disabled Laser File & Qualified buttons ===
(function(){
  const targets = [
    { el: document.getElementById('dlTxt'),  msg: 'Input: PE and QCE ID-NAME first' },
    { el: document.getElementById('dlCsv'),  msg: 'Input: PE and QCE ID-NAME first' },
  ].filter(t => t.el);

  if (!targets.length) return;

  // Shared tooltip element
  const tip = document.createElement('div');
  tip.textContent = '';
  Object.assign(tip.style, {
    position:'fixed', padding:'6px 10px', borderRadius:'8px',
    background:'rgba(220,38,38,0.95)', color:'#fff', fontSize:'12px',
    boxShadow:'0 6px 20px rgba(0,0,0,0.35)', zIndex: 10000, pointerEvents:'none',
    opacity:'0', transform:'translateY(6px)', transition:'opacity .12s ease, transform .12s ease'
  });
  document.body.appendChild(tip);

  function positionTip(btn){
    const r = btn.getBoundingClientRect();
    tip.style.left = (r.left + (r.width/2) - (tip.offsetWidth/2)) + 'px';
    tip.style.top  = (r.top - 10 - tip.offsetHeight) + 'px';
  }

  function showTipFor(btn, msg){
    if (!btn.disabled) return; // only when disabled
    tip.textContent = msg;
    positionTip(btn);
    tip.style.opacity = '1';
    tip.style.transform = 'translateY(0)';
  }
  function hideTip(){
    tip.style.opacity = '0';
    tip.style.transform = 'translateY(6px)';
  }

  targets.forEach(({el, msg}) => {
    ['mouseenter','focus'].forEach(ev => el.addEventListener(ev, () => showTipFor(el, msg)));
    ['mouseleave','blur','click'].forEach(ev => el.addEventListener(ev, hideTip));
  });

  window.addEventListener('resize', () => {
    if (tip.style.opacity === '1') {
      const active = targets.find(t => t.el.matches(':hover'));
      if (active) positionTip(active.el);
    }
  });
})();
</script>








</head>
<body>
  
<script>
// === Qualified: Direct A4 PDF download (no UI writing) ===
(function(){
  function buildQualifiedRows(){
    const lines = window.__lines||[]; if(!lines.length) return [];
    const engName = (document.getElementById('engName')?.value || '').trim();
    const qcName  = (document.getElementById('qcName')?.value || '').trim();
    const rows = [
      {type:'meta', text:`Serial generated by: ${engName}`},
      {type:'meta', text:`Validated/Qualified by: ${qcName}`},
      {type:'header', cols:['Type','Serial']}
    ];
    let idx=0, made=0; const groups = window.__groups||Math.ceil((window.__qty||0)/6);
    for(let g=0; g<groups; g++){
      const inGroup = Math.min(6, (window.__qty||0)-made);
      for(let i=0;i<inGroup;i++){ rows.push({type:'row', cols:['Child', (lines[idx++]||'')]}); made++; }
      rows.push({type:'row', cols:['Mother', (lines[idx++]||'')]});
      rows.push({type:'row', cols:['Mother', (lines[idx++]||'')]});
    }
    return rows;
  }

  function downloadQualifiedPdfDirect(){
    const rows = buildQualifiedRows(); if (!rows.length) return;
    if (!window.jspdf || !window.jspdf.jsPDF) { alert('jsPDF failed to load.'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

    const rawName = ((typeof M!=='undefined' && M.NAME) ? M.NAME : 'Model').replace(/[^A-Za-z0-9 _-]/g,'');
const modelCode = String(((typeof C!=='undefined' && C.AAAAAA) ? C.AAAAAA : ((typeof M!=='undefined' && M.MODEL) ? M.MODEL : ''))).trim();
let displayName;
if (modelCode === '846775') displayName = 'POWER';
else if (modelCode === '846765') displayName = 'USER INTERFACE';
else displayName = rawName;
    const t = new Date();
    const ymd = String(t.getFullYear()) + String(t.getMonth()+1).padStart(2,'0') + String(t.getDate()).padStart(2,'0');

    const page = { w: 595.28, h: 841.89 };
    const margin = { top: 56, right: 56, bottom: 56, left: 56 };
    const col1x = margin.left;
    const col2x = margin.left + 110;
    let y = margin.top;

    // Watermark
    doc.setGState(new doc.GState({ opacity: 0.12 }));
    doc.setFont('helvetica', 'bold'); doc.setFontSize(90);
    doc.setTextColor(185, 28, 28);
    doc.text('QUALIFIED', page.w/2, page.h/2, { angle: -30, align: 'center' });
    doc.setGState(new doc.GState({ opacity: 1 }));

    // Header (model)
    doc.setTextColor(17, 24, 39);
    doc.setFont('helvetica', 'bold'); doc.setFontSize(20);
    doc.text(String(displayName), margin.left, y);

    // Meta
    const meta1 = rows.find(r=>r.type==='meta')?.text || '';
    const meta2 = rows.filter(r=>r.type==='meta')[1]?.text || '';
    doc.setFont('helvetica', 'normal'); doc.setFontSize(11);
    y += 22; doc.text(meta1, margin.left, y);
    y += 16; doc.text(meta2, margin.left, y);
    y += 24;

    // Table header
    doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
    doc.setTextColor(185, 28, 28);
    doc.text('Type', col1x, y);
    doc.text('Serial', col2x, y);
    y += 6;
    doc.setDrawColor(185, 28, 28); doc.setLineWidth(1.5);
    doc.line(margin.left, y, page.w - margin.right, y);
    y += 12;

    // Rows
    doc.setFont('courier', 'normal'); doc.setFontSize(11);
    doc.setTextColor(17, 24, 39);
    const lineH = 16;
    const footerH = 24;

    function newPage(){
      doc.addPage();
      // watermark each page
      doc.setGState(new doc.GState({ opacity: 0.12 }));
      doc.setFont('helvetica', 'bold'); doc.setFontSize(90);
      doc.setTextColor(185, 28, 28);
      doc.text('QUALIFIED', page.w/2, page.h/2, { angle: -30, align: 'center' });
      doc.setGState(new doc.GState({ opacity: 1 }));
      // header again
      y = margin.top;
      doc.setTextColor(17, 24, 39);
      doc.setFont('helvetica', 'bold'); doc.setFontSize(20);
      doc.text(String(displayName), margin.left, y);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(11);
      y += 22; doc.text(meta1, margin.left, y);
      y += 16; doc.text(meta2, margin.left, y);
      y += 24;
      doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
      doc.setTextColor(185, 28, 28);
      doc.text('Type', col1x, y);
      doc.text('Serial', col2x, y);
      y += 6;
      doc.setDrawColor(185, 28, 28); doc.setLineWidth(1.5);
      doc.line(margin.left, y, page.w - margin.right, y);
      y += 12;
      doc.setFont('courier', 'normal'); doc.setFontSize(11);
      doc.setTextColor(17, 24, 39);
    }

    const dataRows = rows.filter(r=>r.type==='row');
    dataRows.forEach(r=>{
      if (y + lineH + footerH > page.h - margin.bottom) newPage();
      doc.text(String(r.cols[0]), col1x, y);
      let serial = String(r.cols[1] ?? '');
      const maxSerialWidth = page.w - margin.right - col2x;
      while (doc.getTextWidth(serial) > maxSerialWidth && serial.length > 4){
        serial = serial.slice(0, -4) + '…';
      }
      doc.text(serial, col2x, y);
      y += lineH;
    });

    // Footer
    doc.setFont('helvetica', 'normal'); doc.setFontSize(8);
    doc.setTextColor(107, 114, 128);
    const footer = `Generated by Ultraguard Tool • ${new Date().toLocaleString()}`;
    doc.text(footer, margin.left, page.h - margin.bottom + 8);

    // Save
    const fileName = `Qualified_${displayName}_${ymd}.pdf`;
    doc.save(fileName);
  }

  // Wire button (ensure old handlers don't leak)
  const btn = document.getElementById('dlCsv');
  if (btn) {
    try { btn.replaceWith(btn.cloneNode(true)); } catch(e) {}
  }
  const reBtn = document.getElementById('dlCsv');
  if (reBtn) {
    reBtn.addEventListener('click', downloadQualifiedPdfDirect);
  }
})();
</script>

</body>
</html>
